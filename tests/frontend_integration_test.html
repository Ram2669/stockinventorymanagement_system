<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Integration Tests - SRI LAKSHMI ENTERPRISES</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #218838;
        }
        .coverage-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        #testResults {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Frontend Integration Tests</h1>
        <p>Comprehensive testing of sales recording functionality</p>
        
        <div>
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
            <button onclick="testSalesRecording()">üí∞ Test Sales Recording</button>
            <button onclick="testUIUpdates()">üîÑ Test UI Updates</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div class="test-container">
            <h3>üìä Test Coverage</h3>
            <div class="coverage-bar">
                <div class="coverage-fill" id="coverageBar" style="width: 0%"></div>
            </div>
            <div id="coverageText">Coverage: 0% (0/0 tests passed)</div>
        </div>
        
        <div class="test-container">
            <h3>üìã Test Results</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Test Configuration
        const API_BASE = 'http://localhost:5001/api';
        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;

        // Test Result Logging
        function logTest(testName, status, message = '') {
            const result = {
                testName,
                status,
                message,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            totalTests++;
            
            if (status === 'PASS') {
                passedTests++;
            }
            
            displayTestResult(result);
            updateCoverage();
        }

        function displayTestResult(result) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            
            let className = 'test-info';
            let icon = '‚ÑπÔ∏è';
            
            if (result.status === 'PASS') {
                className = 'test-pass';
                icon = '‚úÖ';
            } else if (result.status === 'FAIL') {
                className = 'test-fail';
                icon = '‚ùå';
            }
            
            resultDiv.className = `test-result ${className}`;
            resultDiv.innerHTML = `${icon} ${result.testName}: ${result.message}`;
            
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateCoverage() {
            const coverage = totalTests > 0 ? (passedTests / totalTests) * 100 : 0;
            const coverageBar = document.getElementById('coverageBar');
            const coverageText = document.getElementById('coverageText');
            
            coverageBar.style.width = `${coverage}%`;
            coverageText.textContent = `Coverage: ${coverage.toFixed(1)}% (${passedTests}/${totalTests} tests passed)`;
        }

        function clearResults() {
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            document.getElementById('testResults').innerHTML = '';
            updateCoverage();
        }

        // ============================================================================
        // TEST SUITE 1: API CONNECTIVITY TESTS
        // ============================================================================

        async function testAPIConnectivity() {
            try {
                const response = await axios.get(`${API_BASE}/stock`, { timeout: 5000 });
                if (response.status === 200) {
                    logTest('API_CONNECTIVITY', 'PASS', `Connected successfully - ${response.data.length} products loaded`);
                    return true;
                } else {
                    logTest('API_CONNECTIVITY', 'FAIL', `Unexpected status: ${response.status}`);
                    return false;
                }
            } catch (error) {
                logTest('API_CONNECTIVITY', 'FAIL', `Connection failed: ${error.message}`);
                return false;
            }
        }

        async function testStockDataStructure() {
            try {
                const response = await axios.get(`${API_BASE}/stock`);
                const stockData = response.data;
                
                if (!Array.isArray(stockData)) {
                    logTest('STOCK_DATA_STRUCTURE', 'FAIL', 'Stock data is not an array');
                    return false;
                }
                
                if (stockData.length === 0) {
                    logTest('STOCK_DATA_STRUCTURE', 'FAIL', 'No stock data available');
                    return false;
                }
                
                const requiredFields = ['id', 'product_name', 'company_name', 'quantity', 'unit_price'];
                const sampleItem = stockData[0];
                const missingFields = requiredFields.filter(field => !(field in sampleItem));
                
                if (missingFields.length === 0) {
                    logTest('STOCK_DATA_STRUCTURE', 'PASS', `All required fields present in ${stockData.length} items`);
                    return true;
                } else {
                    logTest('STOCK_DATA_STRUCTURE', 'FAIL', `Missing fields: ${missingFields.join(', ')}`);
                    return false;
                }
            } catch (error) {
                logTest('STOCK_DATA_STRUCTURE', 'FAIL', error.message);
                return false;
            }
        }

        // ============================================================================
        // TEST SUITE 2: SALES RECORDING TESTS
        // ============================================================================

        async function testSalesRecording() {
            logTest('SALES_RECORDING_START', 'INFO', 'Starting sales recording tests...');
            
            // Get available stock
            let stockData;
            try {
                const response = await axios.get(`${API_BASE}/stock`);
                stockData = response.data;
                
                const availableProducts = stockData.filter(p => p.quantity > 0);
                if (availableProducts.length === 0) {
                    logTest('SALES_RECORDING_PREP', 'FAIL', 'No products with available stock');
                    return false;
                }
                
                logTest('SALES_RECORDING_PREP', 'PASS', `Found ${availableProducts.length} products with stock`);
            } catch (error) {
                logTest('SALES_RECORDING_PREP', 'FAIL', error.message);
                return false;
            }
            
            // Test different sale scenarios
            await testSaleWithUnitPrice(stockData);
            await testSaleWithoutUnitPrice(stockData);
            await testStockQuantityUpdate(stockData);
            await testDailySalesUpdate();
        }

        async function testSaleWithUnitPrice(stockData) {
            const productsWithPrice = stockData.filter(p => p.quantity > 0 && p.unit_price > 0);
            
            if (productsWithPrice.length === 0) {
                logTest('SALE_WITH_UNIT_PRICE', 'SKIP', 'No products with unit price > 0');
                return;
            }
            
            const testProduct = productsWithPrice[0];
            const saleData = {
                product_name: testProduct.product_name,
                company_name: testProduct.company_name,
                customer_name: 'FRONTEND_TEST_WITH_PRICE',
                quantity_sold: 1,
                unit_price: testProduct.unit_price,
                payment_status: 'paid',
                payment_method: 'cash'
            };
            
            try {
                const response = await axios.post(`${API_BASE}/sales`, saleData);
                
                if (response.status === 201) {
                    const result = response.data;
                    logTest('SALE_WITH_UNIT_PRICE', 'PASS', 
                           `Sale recorded - ID: ${result.sale_id}, Amount: Rs.${result.sale_amount}`);
                } else {
                    logTest('SALE_WITH_UNIT_PRICE', 'FAIL', `Unexpected status: ${response.status}`);
                }
            } catch (error) {
                logTest('SALE_WITH_UNIT_PRICE', 'FAIL', error.message);
            }
        }

        async function testSaleWithoutUnitPrice(stockData) {
            const productsWithoutPrice = stockData.filter(p => p.quantity > 0 && (!p.unit_price || p.unit_price === 0));
            
            if (productsWithoutPrice.length === 0) {
                logTest('SALE_WITHOUT_UNIT_PRICE', 'SKIP', 'No products without unit price');
                return;
            }
            
            const testProduct = productsWithoutPrice[0];
            const saleData = {
                product_name: testProduct.product_name,
                company_name: testProduct.company_name,
                customer_name: 'FRONTEND_TEST_NO_PRICE',
                quantity_sold: 1,
                unit_price: 100, // Custom price
                payment_status: 'paid',
                payment_method: 'cash'
            };
            
            try {
                const response = await axios.post(`${API_BASE}/sales`, saleData);
                
                if (response.status === 201) {
                    const result = response.data;
                    logTest('SALE_WITHOUT_UNIT_PRICE', 'PASS', 
                           `Sale with custom price recorded - ID: ${result.sale_id}, Amount: Rs.${result.sale_amount}`);
                } else {
                    logTest('SALE_WITHOUT_UNIT_PRICE', 'FAIL', `Unexpected status: ${response.status}`);
                }
            } catch (error) {
                logTest('SALE_WITHOUT_UNIT_PRICE', 'FAIL', error.message);
            }
        }

        async function testStockQuantityUpdate(stockData) {
            const availableProducts = stockData.filter(p => p.quantity > 1); // Need at least 2 for testing
            
            if (availableProducts.length === 0) {
                logTest('STOCK_QUANTITY_UPDATE', 'SKIP', 'No products with quantity > 1');
                return;
            }
            
            const testProduct = availableProducts[0];
            const originalQuantity = testProduct.quantity;
            
            // Record sale
            const saleData = {
                product_name: testProduct.product_name,
                company_name: testProduct.company_name,
                customer_name: 'STOCK_UPDATE_TEST',
                quantity_sold: 1,
                unit_price: testProduct.unit_price || 75,
                payment_status: 'paid',
                payment_method: 'cash'
            };
            
            try {
                const saleResponse = await axios.post(`${API_BASE}/sales`, saleData);
                
                if (saleResponse.status === 201) {
                    // Check updated stock
                    const stockResponse = await axios.get(`${API_BASE}/stock`);
                    const updatedStock = stockResponse.data;
                    const updatedProduct = updatedStock.find(p => p.id === testProduct.id);
                    
                    if (updatedProduct) {
                        const expectedQuantity = originalQuantity - 1;
                        const actualQuantity = updatedProduct.quantity;
                        
                        if (actualQuantity === expectedQuantity) {
                            logTest('STOCK_QUANTITY_UPDATE', 'PASS', 
                                   `Stock updated correctly: ${originalQuantity} ‚Üí ${actualQuantity}`);
                        } else {
                            logTest('STOCK_QUANTITY_UPDATE', 'FAIL', 
                                   `Stock mismatch: expected ${expectedQuantity}, got ${actualQuantity}`);
                        }
                    } else {
                        logTest('STOCK_QUANTITY_UPDATE', 'FAIL', 'Product not found after sale');
                    }
                } else {
                    logTest('STOCK_QUANTITY_UPDATE', 'FAIL', `Sale failed: ${saleResponse.status}`);
                }
            } catch (error) {
                logTest('STOCK_QUANTITY_UPDATE', 'FAIL', error.message);
            }
        }

        async function testDailySalesUpdate() {
            try {
                // Get initial daily sales
                const initialResponse = await axios.get(`${API_BASE}/sales/daily`);
                const initialCount = initialResponse.data.summary.total_sales;
                
                // Record a test sale
                const stockResponse = await axios.get(`${API_BASE}/stock`);
                const availableProducts = stockResponse.data.filter(p => p.quantity > 0);
                
                if (availableProducts.length === 0) {
                    logTest('DAILY_SALES_UPDATE', 'SKIP', 'No products available for test');
                    return;
                }
                
                const testProduct = availableProducts[0];
                const saleData = {
                    product_name: testProduct.product_name,
                    company_name: testProduct.company_name,
                    customer_name: 'DAILY_SALES_TEST',
                    quantity_sold: 1,
                    unit_price: testProduct.unit_price || 60,
                    payment_status: 'paid',
                    payment_method: 'cash'
                };
                
                const saleResponse = await axios.post(`${API_BASE}/sales`, saleData);
                
                if (saleResponse.status === 201) {
                    // Check updated daily sales
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                    
                    const updatedResponse = await axios.get(`${API_BASE}/sales/daily`);
                    const updatedCount = updatedResponse.data.summary.total_sales;
                    
                    if (updatedCount > initialCount) {
                        logTest('DAILY_SALES_UPDATE', 'PASS', 
                               `Daily sales updated: ${initialCount} ‚Üí ${updatedCount}`);
                    } else {
                        logTest('DAILY_SALES_UPDATE', 'FAIL', 
                               `Daily sales not updated: ${initialCount} ‚Üí ${updatedCount}`);
                    }
                } else {
                    logTest('DAILY_SALES_UPDATE', 'FAIL', `Test sale failed: ${saleResponse.status}`);
                }
            } catch (error) {
                logTest('DAILY_SALES_UPDATE', 'FAIL', error.message);
            }
        }

        // ============================================================================
        // TEST SUITE 3: UI UPDATE TESTS
        // ============================================================================

        async function testUIUpdates() {
            logTest('UI_UPDATES_START', 'INFO', 'Starting UI update tests...');
            
            // These tests would normally interact with DOM elements
            // For now, we'll test the API responses that drive UI updates
            
            await testDailySalesAPIResponse();
            await testStockAPIResponse();
        }

        async function testDailySalesAPIResponse() {
            try {
                const response = await axios.get(`${API_BASE}/sales/daily`);
                const data = response.data;
                
                // Check required structure for UI updates
                const requiredKeys = ['sales', 'summary'];
                const summaryKeys = ['total_sales', 'total_revenue', 'paid_sales', 'unpaid_sales'];
                
                const missingKeys = requiredKeys.filter(key => !(key in data));
                const missingSummaryKeys = summaryKeys.filter(key => !(key in data.summary));
                
                if (missingKeys.length === 0 && missingSummaryKeys.length === 0) {
                    logTest('DAILY_SALES_API_STRUCTURE', 'PASS', 
                           `API returns complete data for UI updates - ${data.sales.length} sales`);
                } else {
                    logTest('DAILY_SALES_API_STRUCTURE', 'FAIL', 
                           `Missing keys: ${[...missingKeys, ...missingSummaryKeys].join(', ')}`);
                }
            } catch (error) {
                logTest('DAILY_SALES_API_STRUCTURE', 'FAIL', error.message);
            }
        }

        async function testStockAPIResponse() {
            try {
                const response = await axios.get(`${API_BASE}/stock`);
                const data = response.data;
                
                if (Array.isArray(data) && data.length > 0) {
                    const hasRequiredFields = data.every(item => 
                        'product_name' in item && 'quantity' in item && 'unit_price' in item
                    );
                    
                    if (hasRequiredFields) {
                        logTest('STOCK_API_STRUCTURE', 'PASS', 
                               `Stock API returns complete data for UI updates - ${data.length} products`);
                    } else {
                        logTest('STOCK_API_STRUCTURE', 'FAIL', 'Some stock items missing required fields');
                    }
                } else {
                    logTest('STOCK_API_STRUCTURE', 'FAIL', 'Stock API returns invalid data structure');
                }
            } catch (error) {
                logTest('STOCK_API_STRUCTURE', 'FAIL', error.message);
            }
        }

        // ============================================================================
        // MAIN TEST RUNNER
        // ============================================================================

        async function runAllTests() {
            clearResults();
            logTest('TEST_SUITE_START', 'INFO', 'Starting comprehensive frontend integration tests...');
            
            // Test Suite 1: API Connectivity
            const apiConnected = await testAPIConnectivity();
            if (!apiConnected) {
                logTest('TEST_SUITE_ABORT', 'FAIL', 'API not accessible - aborting remaining tests');
                return;
            }
            
            await testStockDataStructure();
            
            // Test Suite 2: Sales Recording
            await testSalesRecording();
            
            // Test Suite 3: UI Updates
            await testUIUpdates();
            
            // Final report
            const coverage = totalTests > 0 ? (passedTests / totalTests) * 100 : 0;
            
            if (coverage >= 95) {
                logTest('TEST_SUITE_COMPLETE', 'PASS', 
                       `üéâ All tests completed! Coverage: ${coverage.toFixed(1)}% - EXCELLENT!`);
            } else if (coverage >= 80) {
                logTest('TEST_SUITE_COMPLETE', 'PASS', 
                       `‚úÖ Tests completed! Coverage: ${coverage.toFixed(1)}% - GOOD!`);
            } else {
                logTest('TEST_SUITE_COMPLETE', 'FAIL', 
                       `‚ö†Ô∏è Tests completed! Coverage: ${coverage.toFixed(1)}% - NEEDS IMPROVEMENT`);
            }
        }

        // Auto-run tests when page loads
        window.addEventListener('load', function() {
            logTest('FRONTEND_TEST_INIT', 'INFO', 'Frontend integration test suite loaded and ready');
        });
    </script>
</body>
</html>
